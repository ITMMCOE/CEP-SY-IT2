/**
 * @file Firebase Security Rules for CivicConnect.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model. Users can only write/read
 * their own data. Authorities can read all global reports.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    function isSignedIn() {
      return request.auth != null;
    }
    
    function isAuthority() {
      // An authority is a user whose UID exists as a document in the /authorities collection.
      return isSignedIn() && exists(/databases/$(database)/documents/authorities/$(request.auth.uid));
    }

    /**
     * User Profiles: Only the owner can read/write their own profile.
     */
    match /users/{userId} {
      allow read, write: if isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Authority flags: Only the owner can create/read their own authority status document.
     * This is locked down to prevent users from making themselves authorities. In a real app,
     * this would be managed by an admin role. For now, it's tied to the registration flow.
     */
    match /authorities/{userId} {
      allow read, create: if isSignedIn() && request.auth.uid == userId;
      allow list, update, delete: if false;
    }
    
    /**
     * User-specific reports subcollection.
     */
    match /users/{userId}/reports/{reportId} {
      // The user must be the owner of this subcollection path.
      function isOwner() {
        return request.auth.uid == userId;
      }
      
      // Allow the owner to read their own reports.
      allow read, list: if isOwner();

      // IMPORTANT: Validate that the incoming data's userId matches the authenticated user.
      // This is the correct way to secure 'create' operations.
      allow create: if isOwner() && request.resource.data.userId == request.auth.uid;
      
      // Allow owner to update or delete their reports.
      allow update, delete: if isOwner();
    }
    
    /**
     * Global reports collection for authority access.
     */
    match /reports/{reportId} {
      // Any signed-in user can create a report.
      // We validate that the 'userId' field in the new document matches the authenticated user's UID.
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      
      // Only authorities can read from the global reports collection.
      allow read, list: if isAuthority();

      // Only authorities can update or delete reports.
      allow update, delete: if isAuthority();
    }
  }
}
